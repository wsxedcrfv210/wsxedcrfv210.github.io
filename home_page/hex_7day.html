<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" href="assets/css/main.css" />
<link rel="stylesheet" href="assets/css/lottery.css" />
<body style="background-color : transparent">
    <div class="container"><div class="lottery"></div></div>

<script src="assets/js/d3.v3.min.js"></script>
<script src="assets/js/d3.hexbin.min.js"></script>
<script src="assets/js/d3.tip.v0.6.3.js"></script>
<script>

var diameter = 900,
    format = d3.format(",d");
/*var color = d3.scale.category20()
    .domain(d3.range(20));*/

var colorArray = [ "#F3F3FA" , "#C7C7E2" , "#9999CC" , "#5A5AAD" ];

var jsonname = "assets/json/lotterydata_7day.json";

 // --- 轉換巢狀結構的key ---   
function reSortRoot(root,value_key) {
    for (var key in root) {
      if (key == "key") {
        root.name = root.key;
        delete root.key;
      }
      if (key == "values") {
        root.children = [];
        for (item in root.values) {
          root.children.push(reSortRoot(root.values[item],value_key));
        }
        delete root.values;
      }
      if (key == value_key) {
        root.value = parseFloat(root[value_key]);
        delete root[value_key];
      }
    }
    return root;
  }
// --- 轉換巢狀結構的key ---  

d3.json(jsonname, function(root) {
  

  console.log(root, "原始資料")

 var nodesBydate = d3.nest()
        .key(function(d,i){return d.created_time;})
        .entries(root);

    //console.log(nodesBydate, "基本巢狀結構轉換")

    var d = {};

    //將資料命名
    d.key = "flare";
    d.values = nodesBydate;

    //修改資料的key,children名稱

    root = reSortRoot(d,"children");
    

    console.log(root, "巢狀結構")



    
var pack = d3.layout.pack()
    .size([diameter - 100, diameter - 270])
    .value(function(d) { return 20; }).padding(5);
    
var hexbin = d3.hexbin()
    .size([diameter, diameter])
    .radius(function(d) { return d.r*2/Math.sqrt(3); });
    
//var radius = d3.attr("d", function(d) { return hexbin.hexagon(d.r); })
var ss = d3.tip().direction(function(d) {return 'e'})
    .attr('class', 'd3-tip')
    .offset([-10, 0])
    .html(function(d) {
    if(d.start_activetime == null || d.end_activetime == null ){
        return "<span style='color:white'>活動詳見內文</span>";
    }
    else if((d.start_activetime != null || d.end_activetime != null) && d.lottery_time == null){
        var enddate = d.end_activetime.split(":");
        //console.log(enddate);
        if((Date.parse(enddate[1])).valueOf() < (Date.parse(new Date().toDateString())).valueOf()){
            //console.log("過期");
            return "<span style='color:red'>"+"****活動已過期****"+"<br>" + d.start_activetime +"<br>"+ d.end_activetime + "</span>";
        }
        else{
            return "<span style='color:white'>" + d.start_activetime +"<br>"+ d.end_activetime + "</span>";
        }
    }
    else{
         var enddate = d.end_activetime.split(":");
        if((Date.parse(enddate[1])).valueOf() < (Date.parse(new Date().toDateString())).valueOf()){
            // console.log("過期");
            return "<span style='color:red'>" + "****活動已過期****"+"<br>" + d.start_activetime +"<br>"+ d.end_activetime +"<br>" + d.lottery_time + "</span>";
        }
        else{
            return "<span style='color:white'>" + d.start_activetime +"<br>"+ d.end_activetime +"<br>" + d.lottery_time + "</span>";
        }
    }
  });
var svg2 = d3.select(".lottery").append("svg")
    .attr("width", diameter)
    .attr("height", diameter)
    .append("g")
    .attr("transform", "translate(2,2)")
    .call(ss);  
    
  var node = svg2.datum(root).selectAll(".node")
      .data(pack.nodes)
      .enter().append("g")
      .attr("class", function(d) { return d.children ? "node" : "leaf node"; })
      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
 //console.log(root.children.length);   
var days = root.children.length - 1;
//svg.call(tip);
//console.log(root.children[days]);   
  /*  
node.append("title")
      .text(function(d) { return d.name + (d.children ? "" : ": " + format(d.size)); });*/
    
node.filter(function(d) { return d.children && (d.name != "flare"); })
    .append("path")
    //.attr("transform", function(d) {return "translate(" + d.x + "," + d.y + ")"; })
    .attr("d", function(d) { return hexbin.hexagon(d.r*2/Math.sqrt(3)); })
    .style("fill", "steelblue")
    .style("stroke", "white")
    .style("opacity",0.5);
    
node.filter(function(d) {return !d.children; })
    .append("path") 
    .attr("d", function(d) { return hexbin.hexagon(d.r*2/Math.sqrt(3)); })
    .style("fill", function(d) { 
        if(d.size <= 1000){return colorArray[3];} 
        else if(1000 < d.size && d.size<= 1500){return colorArray[2];}
        else if(1500 < d.size && d.size<= 2000){return colorArray[1];}
        else if(2000 < d.size ){return colorArray[0];}
    })
    .style("stroke", "gray")
    .on('mouseover', ss.show)
    .on('mouseout', ss.hide);
//console.log(root.children[i].children.length);


node.filter(function(d) { return !d.children; }).append("text")
      .attr("y", ".3em")
      .style("text-anchor", "middle")
      .text(function(d) { return d.from_name.substring(0, d.r / 8); })
    .on('mouseover', ss.show)
    .on('mouseout', ss.hide);;
    
node.filter(function(d) { return d.children && (d.name != "flare"); }).append("text")
    .attr("transform", function(d) { return "translate(" + 0 + "," + -d.r*0.9  + ")"; })
      .attr("y", ".3em")
      .style("font-size", "12px")
      .style("fill", "gray")
      .style("text-anchor", "middle")
      .text(function(d) { return d.name.substring(0, d.r / 3); });
     
});     

//d3.select(self.frameElement).style("height", diameter + "px");

</script>
</body>