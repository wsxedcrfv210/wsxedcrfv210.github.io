<!DOCTYPE html>
<meta charset="utf-8">
<style>
path {
  fill: rgb(31, 119, 180);
  fill-opacity: .25;
  stroke: rgb(31, 119, 180);
  stroke-width: 1px;
}

.leaf path {
  fill: #ff7f0e;
  fill-opacity: 1;
}
.d3-tip {
  line-height: 1;
  font-weight: bold;
  padding: 12px;
  background: rgba(174,87,164, 1);
  color: #fff;
  border-radius: 2px;
}
    
text {
  font: 10px sans-serif;
}
text2 {
  font: 20px sans-serif;
}

</style>
<body>
    <div class=lottery></div>
<script src="assets/js/d3.v3.min.js"></script>
<script src="assets/js/d3.hexbin.min.js"></script>
<script src="assets/js/d3.tip.v0.6.3.js"></script>
<script>

var diameter = 700,
    format = d3.format(",d");
/*var color = d3.scale.category20()
    .domain(d3.range(20));*/

var colorArray = [ "#F3F3FA" , "#C7C7E2" , "#9999CC" , "#5A5AAD" ];

var jsonname = "assets/json/lotteryjieba.json";

 // --- 轉換巢狀結構的key ---   
function reSortRoot(root,value_key) {
    for (var key in root) {
      if (key == "key") {
        root.name = root.key;
        delete root.key;
      }
      if (key == "values") {
        root.children = [];
        for (item in root.values) {
          root.children.push(reSortRoot(root.values[item],value_key));
        }
        delete root.values;
      }
      if (key == value_key) {
        root.value = parseFloat(root[value_key]);
        delete root[value_key];
      }
    }
    return root;
  }
// --- 轉換巢狀結構的key ---  

d3.json(jsonname, function(root) {
  

//  console.log(root, "原始資料")

 var nodesBydate = d3.nest()
        .key(function(d,i){return d.created_time;})
        .entries(root);

    //console.log(nodesBydate, "基本巢狀結構轉換")

    var d = {};

    //將資料命名
    d.key = "name";
    d.values = nodesBydate;

    //修改資料的key,children名稱

    root = reSortRoot(d,"children");
    

    //console.log(root, "巢狀結構")



    
var pack = d3.layout.pack()
    .size([diameter - 100, diameter])
    .value(function(d) { return 20; }).padding(2);
    
var hexbin = d3.hexbin()
    .size([diameter, diameter])
    .radius(function(d) { return d.r*2/Math.sqrt(3); });
    
//var radius = d3.attr("d", function(d) { return hexbin.hexagon(d.r); })

var svg = d3.select(".lottery").append("svg")
    .attr("width", diameter)
    .attr("height", diameter)
    .append("g")
    .attr("transform", "translate(2,2)");  
    
  var node = svg.datum(root).selectAll(".node")
      .data(pack.nodes)
      .enter().append("g")
      .attr("class", function(d) { return d.children ? "node" : "leaf node"; })
      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
 //console.log(root.children.length);   
var days = root.children.length - 1;
var tip = d3.select('.lottery');
tip = d3.tip()
    .attr('class', "d3-tip")
    .offset([-10, 0])
    .html(function(d) {
    if(d.satrtactivetime == null || d.endactivetime == null ){
        return "<span style='color:white'>活動詳見內文</span>";
    }
    else if((d.satrtactivetime != null || d.endactivetime != null) && d.openactivetime == null){
        var enddate = d.endactivetime.split(":");
        //console.log(enddate);
        if((Date.parse(enddate[1])).valueOf() < (Date.parse(new Date().toDateString())).valueOf()){
            //console.log("過期");
            return "<span style='color:red'>"+"****活動已過期****"+"<br>" + d.satrtactivetime +"<br>"+ d.endactivetime + "</span>";
        }
        else{
            return "<span style='color:white'>" + d.satrtactivetime +"<br>"+ d.endactivetime + "</span>";
        }
    }
    else{
         var enddate = d.endactivetime.split(":");
        if((Date.parse(enddate[1])).valueOf() < (Date.parse(new Date().toDateString())).valueOf()){
            // console.log("過期");
            return "<span style='color:red'>" + "****活動已過期****"+"<br>" + d.satrtactivetime +"<br>"+ d.endactivetime +"<br>" + d.openactivetime + "</span>";
        }
        else{
            return "<span style='color:white'>" + d.satrtactivetime +"<br>"+ d.endactivetime +"<br>" + d.openactivetime + "</span>";
        }
    }
  });
//console.log(root.children[days]);   
  /*  
node.append("title")
      .text(function(d) { return d.name + (d.children ? "" : ": " + format(d.size)); });*/
    
node.filter(function(d) { return d.children && (d.name != "name"); })
    .append("path")
    //.attr("transform", function(d) {return "translate(" + d.x + "," + d.y + ")"; })
    .attr("d", function(d) {d=root.children[days]; return hexbin.hexagon(d.r*2/Math.sqrt(3)); })
    .style("fill", "steelblue")
    .style("stroke", "black")
    .style("opacity",0.5);
    
node.filter(function(d) { return !d.children; })
    .append("path") 
    .attr("d", function(d) { return hexbin.hexagon(d.r*2/Math.sqrt(3)); })
    .style("fill", function(d) { 
        if(d.size <= 50){return colorArray[3];} 
        else if(50 < d.size && d.size<= 150){return colorArray[2];}
        else if(150 < d.size && d.size<= 300){return colorArray[1];}
        else if(300 < d.size && d.size<= 400){return colorArray[0];}
    })
    .style("stroke", "gray")
    .on('mouseover', tip.show)
    .on('mouseout', tip.hide);
//console.log(root.children[i].children.length);


node.filter(function(d) { return !d.children; }).append("text")
      .attr("y", ".3em")
      .style("text-anchor", "middle")
      .text(function(d) { return d.from_name.substring(0, d.r / 8); });
    
node.filter(function(d) { return d.children && (d.name != "name"); }).append("text")
    .attr("transform", function(d) { return "translate(" + 0 + "," + -d.r*0.9  + ")"; })
      .attr("y", ".3em")
      .style("font-size", "20px")
      .style("fill", "gray")
      .style("text-anchor", "middle")
      .text(function(d) { return d.name.substring(0, d.r / 3); });
    svg.call(tip);
     
});     

d3.select(self.frameElement).style("height", diameter + "px");

</script>